<div class="container py-5">
    <h1 class="mb-5">ğŸ“Š JSON â‡„ CSV/TSV å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="p-4 mb-5 bg-light rounded-3 shadow-sm">
        <p>JSONãƒ‡ãƒ¼ã‚¿ã¨CSV/TSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’åŒæ–¹å‘ã«å¤‰æ›ã—ã¾ã™ã€‚ãƒã‚¹ãƒˆã•ã‚ŒãŸJSONã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚</p>
        
        <div id="jsonCsvFormResult" class="alert mt-3" style="display:none;"></div>
        
        <form id="jsonCsvForm" onsubmit="handleJsonCsvConversion(event)">
            <div class="mb-3">
                <label for="inputText" class="form-label">å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (JSONé…åˆ—ã¾ãŸã¯CSV)</label>
                <textarea id="inputText" name="inputText" class="form-control" rows="15" placeholder="JSONé…åˆ— ([{...}, {...}]) ã¾ãŸã¯ CSVãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" required></textarea>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="mode" class="form-label">å¤‰æ›ãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="mode" name="mode" class="form-select" required>
                        <option value="jsonToCsv">JSON â†’ CSV</option>
                        <option value="csvToJson">CSV â†’ JSON</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="delimiter" class="form-label">åŒºåˆ‡ã‚Šæ–‡å­—</label>
                    <select id="delimiter" name="delimiter" class="form-select">
                        <option value=",">ã‚«ãƒ³ãƒ (CSV)</option>
                        <option value="\t">ã‚¿ãƒ– (TSV)</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary me-2">å¤‰æ›ã‚’å®Ÿè¡Œ</button>
            <button type="button" class="btn btn-secondary" onclick="clearResults('jsonCsvForm', 'inputText', 'resultText')">ã‚¯ãƒªã‚¢</button>
        </form>

        <div class="mt-5">
            <label for="resultText" class="form-label">å¤‰æ›çµæœ</label>
            <textarea id="resultText" name="resultText" class="form-control" rows="15" readonly placeholder="ã“ã“ã«å¤‰æ›çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"></textarea>
        </div>
    </div>
</div>

<script>
/**
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: çµæœ/ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
 */
function displayResult(formId, message, isError) {
    const resultDiv = document.getElementById(formId + 'Result');
    if (!resultDiv) return;

    resultDiv.innerHTML = message;
    resultDiv.className = isError 
        ? 'alert alert-danger mt-3' 
        : 'alert alert-success mt-3';
    resultDiv.style.display = 'block';
}

/**
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®å‡¦ç†
 */
function clearResults(formId, inputId, resultId) {
    document.getElementById(inputId).value = '';
    document.getElementById(resultId).value = '';
    const resultDiv = document.getElementById(formId + 'Result');
    if (resultDiv) {
        resultDiv.style.display = 'none';
    }
}

/**
 * CSVå€¤ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— (ã‚«ãƒ³ãƒã‚„å¼•ç”¨ç¬¦ãŒå«ã¾ã‚Œã‚‹å ´åˆ)
 */
function escapeCsv(value) {
    if (value === null || value === undefined) return "";
    let str = String(value);
    
    // å€¤ã«ã‚«ãƒ³ãƒã€äºŒé‡å¼•ç”¨ç¬¦ã€æ”¹è¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯äºŒé‡å¼•ç”¨ç¬¦ã§å›²ã‚€
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        // æ—¢å­˜ã®äºŒé‡å¼•ç”¨ç¬¦ã¯äºŒé‡ã«ã™ã‚‹
        str = str.replace(/"/g, '""');
        return `"${str}"`;
    }
    return str;
}

/**
 * JSONé…åˆ—ã‚’CSVãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
 */
function jsonToCsv(jsonString, delimiter) {
    let jsonArray;
    try {
        jsonArray = JSON.parse(jsonString);
    } catch (e) {
        throw new Error('å…¥åŠ›ã•ã‚ŒãŸJSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
    }

    if (!Array.isArray(jsonArray) || jsonArray.length === 0) {
        return "";
    }

    // ã™ã¹ã¦ã®ã‚­ãƒ¼ã‚’åé›† (ãƒã‚¹ãƒˆã•ã‚ŒãŸJSONã¯ç„¡è¦–)
    const keysSet = new Set();
    jsonArray.forEach(obj => {
        // ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„é…åˆ—ã¯ã‚­ãƒ¼ã¨ã—ã¦é™¤å¤–ã›ãšã«ã€å€¤ã¨ã—ã¦å‡¦ç†
        Object.keys(obj).forEach(key => keysSet.add(key));
    });

    const keys = Array.from(keysSet);
    const rows = [];

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
    rows.push(keys.join(delimiter));

    // ãƒ‡ãƒ¼ã‚¿è¡Œ
    jsonArray.forEach(obj => {
        const row = keys.map(key => {
            const value = obj[key];
            // ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„é…åˆ—ã¯æ–‡å­—åˆ—åŒ–ã—ã¦CSVå€¤ã¨ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            if (typeof value === 'object' && value !== null) {
                return escapeCsv(JSON.stringify(value));
            }
            return escapeCsv(value);
        });
        rows.push(row.join(delimiter));
    });

    return rows.join('\n');
}

/**
 * CSVãƒ†ã‚­ã‚¹ãƒˆã‚’JSONé…åˆ—ã«å¤‰æ›
 */
function csvToJson(csvString, delimiter) {
    const lines = csvString.trim().split('\n');
    if (lines.length < 2) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã¿ã®å ´åˆã¾ãŸã¯ç©ºã®å ´åˆ
        return "[]";
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®å‡¦ç† (ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ãªã„ã¨ä»®å®š)
    const headers = lines[0].split(delimiter).map(h => h.trim());
    const jsonArray = [];

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // ç°¡å˜ãªCSVãƒ‘ãƒ¼ã‚¹ (å¼•ç”¨ç¬¦å†…ã®åŒºåˆ‡ã‚Šæ–‡å­—ã¯æœªå¯¾å¿œ)
        const values = line.split(delimiter);
        const obj = {};
        
        for (let j = 0; j < headers.length; j++) {
            const value = j < values.length ? values[j].trim() : "";
            obj[headers[j]] = value;
        }
        jsonArray.push(obj);
    }

    // è¦‹ã‚„ã™ã„ã‚ˆã†ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä»˜ãã§JSONã‚’è¿”ã™
    return JSON.stringify(jsonArray, null, 2);
}


/**
 * ãƒ¡ã‚¤ãƒ³ã®å¤‰æ›ãƒãƒ³ãƒ‰ãƒ©
 */
function handleJsonCsvConversion(event) {
    event.preventDefault(); 
    const formId = 'jsonCsvForm';
    const form = document.getElementById(formId);
    
    const inputText = form.elements['inputText'].value.trim();
    const mode = form.elements['mode'].value;
    const delimiterValue = form.elements['delimiter'].value;

    // TSVã®ãŸã‚ã®ã‚¿ãƒ–æ–‡å­—ã‚’æ±ºå®š
    const delimiter = delimiterValue === '\\t' ? '\t' : delimiterValue; 
    
    const resultTextarea = document.getElementById('resultText');

    if (!inputText) {
        displayResult(formId, 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
        resultTextarea.value = '';
        return;
    }

    try {
        let result;
        if (mode === 'jsonToCsv') {
            result = jsonToCsv(inputText, delimiter);
        } else {
            result = csvToJson(inputText, delimiter);
        }

        resultTextarea.value = result;
        displayResult(formId, `${mode === 'jsonToCsv' ? 'JSON' : 'CSV'}ã‹ã‚‰${mode === 'jsonToCsv' ? 'CSV' : 'JSON'}ã¸ã®å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`, false);
        
    } catch (e) {
        resultTextarea.value = '';
        displayResult(formId, `ã‚¨ãƒ©ãƒ¼: ${e.message}`, true);
    }
}
</script>