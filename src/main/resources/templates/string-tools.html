<div class="container py-5">
    <h1 class="mb-5">⚙️ 文字列操作・変換ユーティリティ</h1>
    
    <div class="p-4 mb-5 bg-light rounded-3 shadow-sm">
        <h2 class="mb-4 fs-4">Base64 エンコード / デコード</h2>
        <div id="base64FormResult" class="alert mt-3" style="display:none;"></div>
        
        <form id="base64Form" onsubmit="handleBase64Conversion(event)">
            <div class="mb-3">
                <label for="base64Input" class="form-label">入力テキスト</label>
                <textarea id="base64Input" name="base64Input" class="form-control" rows="8" placeholder="エンコードまたはデコードしたいテキスト/Base64文字列を入力してください。" required></textarea>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="base64Mode" class="form-label">操作</label>
                    <select id="base64Mode" name="base64Mode" class="form-select" required>
                        <option value="encode">テキスト → Base64 (エンコード)</option>
                        <option value="decode">Base64 → テキスト (デコード)</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary me-2">実行</button>
            <button type="button" class="btn btn-secondary" onclick="clearStringResults('base64Form', 'base64Input', 'base64Result')">クリア</button>
        </form>

        <div class="mt-5">
            <label for="base64Result" class="form-label">結果</label>
            <textarea id="base64Result" name="base64Result" class="form-control" rows="8" readonly placeholder="ここに結果が表示されます。"></textarea>
        </div>
    </div>
    
    <div class="p-4 mb-5 bg-light rounded-3 shadow-sm">
        <h2 class="mb-4 fs-4">URL エンコード / デコード</h2>
        <div id="urlFormResult" class="alert mt-3" style="display:none;"></div>
        
        <form id="urlForm" onsubmit="handleUrlConversion(event)">
            <div class="mb-3">
                <label for="urlInput" class="form-label">入力文字列</label>
                <textarea id="urlInput" name="urlInput" class="form-control" rows="8" placeholder="エンコード/デコードしたいURLまたは文字列を入力してください。" required></textarea>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="urlMode" class="form-label">操作</label>
                    <select id="urlMode" name="urlMode" class="form-select" required>
                        <option value="encode">URLエンコード (パーセントエンコーディング)</option>
                        <option value="decode">URLデコード</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary me-2">実行</button>
            <button type="button" class="btn btn-secondary" onclick="clearStringResults('urlForm', 'urlInput', 'urlResult')">クリア</button>
        </form>

        <div class="mt-5">
            <label for="urlResult" class="form-label">結果</label>
            <textarea id="urlResult" name="urlResult" class="form-control" rows="8" readonly placeholder="ここに結果が表示されます。"></textarea>
        </div>
    </div>

    </div>

<script>
/**
 * ユーティリティ: 結果/エラーメッセージを表示する関数
 */
function displayStringResult(formId, message, isError) {
    const resultDiv = document.getElementById(formId + 'Result');
    if (!resultDiv) return;

    resultDiv.innerHTML = message;
    resultDiv.className = isError 
        ? 'alert alert-danger mt-3' 
        : 'alert alert-success mt-3';
    resultDiv.style.display = 'block';
}

/**
 * ユーティリティ: クリアボタンの処理
 */
function clearStringResults(formId, inputId, resultId) {
    document.getElementById(inputId).value = '';
    document.getElementById(resultId).value = '';
    const resultDiv = document.getElementById(formId + 'Result');
    if (resultDiv) {
        resultDiv.style.display = 'none';
    }
}

// =========================================================
// 1. Base64 変換ロジック
// =========================================================
function handleBase64Conversion(event) {
    event.preventDefault(); 
    const formId = 'base64Form';
    const form = document.getElementById(formId);
    
    const input = form.elements['base64Input'].value.trim();
    const mode = form.elements['base64Mode'].value;
    const resultTextarea = document.getElementById('base64Result');

    if (!input) {
        displayStringResult(formId, '入力テキストを入力してください。', true);
        resultTextarea.value = '';
        return;
    }

    try {
        let result = '';
        if (mode === 'encode') {
            // テキストをBase64にエンコード
            // btoaはASCII文字列にしか使えないため、日本語対応のためにはUTF-8を処理する必要があります。
            // サーバー負荷軽減が目的なので、ここでは簡易的な日本語対応ロジックを使用します。
            const utf8Encoded = new TextEncoder().encode(input);
            result = btoa(String.fromCharCode.apply(null, utf8Encoded));
            displayStringResult(formId, 'Base64エンコードが完了しました。', false);
        } else {
            // Base64からテキストにデコード
            const decoded = atob(input);
            // デコードされたバイトデータをUTF-8テキストに戻す
            const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
            result = new TextDecoder().decode(bytes);
            displayStringResult(formId, 'Base64デコードが完了しました。', false);
        }
        
        resultTextarea.value = result;

    } catch (e) {
        resultTextarea.value = '';
        displayStringResult(formId, 'エラー: 入力形式が不正です。デコードの場合、有効なBase64文字列を入力してください。', true);
    }
}

// =========================================================
// 2. URL 変換ロジック
// =========================================================
function handleUrlConversion(event) {
    event.preventDefault(); 
    const formId = 'urlForm';
    const form = document.getElementById(formId);
    
    const input = form.elements['urlInput'].value.trim();
    const mode = form.elements['urlMode'].value;
    const resultTextarea = document.getElementById('urlResult');

    if (!input) {
        displayStringResult(formId, '入力文字列を入力してください。', true);
        resultTextarea.value = '';
        return;
    }

    try {
        let result = '';
        if (mode === 'encode') {
            // URLエンコード (encodeURIComponentを使用)
            result = encodeURIComponent(input);
            displayStringResult(formId, 'URLエンコードが完了しました。', false);
        } else {
            // URLデコード (decodeURIComponentを使用)
            result = decodeURIComponent(input);
            displayStringResult(formId, 'URLデコードが完了しました。', false);
        }
        
        resultTextarea.value = result;

    } catch (e) {
        resultTextarea.value = '';
        displayStringResult(formId, 'エラー: 入力形式が不正です。デコードの場合、不正なパーセントエンコーディングが含まれています。', true);
    }
}
</script>